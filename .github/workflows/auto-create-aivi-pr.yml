name: Check and Create PR

on:
  pull_request:
    types: [closed]

jobs:
  check-label-and-create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check if PR was merged and has 'aivi' label and targets 'develop' branch
        id: check_pr
        run: |
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "PR was not merged. Exiting."
            exit 0
          fi

          if [ "${{ github.event.pull_request.base.ref }}" != "develop" ]; then
            echo "PR base branch is not 'develop'. Exiting."
            exit 0
          fi

          LABELS=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                        https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels \
                        | jq -r '.[].name')

          echo "PR labels: $LABELS"

          if [[ "$LABELS" != *"aivi"* ]]; then
            echo "PR does not have 'aivi' label. Exiting."
            exit 0
          fi

          echo "PR has 'aivi' label and targets 'develop' branch. Proceeding to create a new PR."

      - name: Create a new PR to aivi branch
        run: |
          BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          PR_TITLE="Merge $BRANCH_NAME into aivi"
          PR_BODY="This PR was automatically created to merge $BRANCH_NAME into the aivi branch."

          curl -L \
	          -X POST \
            -H "Accept: application/vnd.github+json" \
		        -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d @- <<EOF
          {
            "title": "$PR_TITLE",
            "head": "$BRANCH_NAME",
            "base": "aivi",
            "body": "$PR_BODY"
          }
          EOF
